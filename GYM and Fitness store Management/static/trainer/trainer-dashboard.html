<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Fitness Trainer - Workout Plan & Exercise Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/trainer-dashboard.css">
  </head>

  <body>
    <aside class="sidebar">
      <div>
        <a href="trainer-dashboard.html" class="logo">
          <img
            src="https://cdn.pixabay.com/photo/2014/03/25/16/25/gym-297059_640.png"
            alt="Trainer Logo" />
          <h2>E-Fitness Trainer</h2>
        </a>

        <nav class="main-nav">
          <a href="trainer-reg-and-profile.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            Profile Management
          </a>
          <a href="trainer-Diet-Plan-Management.html"
            class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 17v-2a4 4 0 014-4h4" />
              </svg>
            </div>
            Diet Plan Management
          </a>
          <a href="trainer-Workout-Plan-Management.html"
            class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 17v-2a4 4 0 014-4h4" />
              </svg>
            </div>
            Workout Plan Management
          </a>
          <a href="trainer-client-management.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 8h10M7 12h8m-8 4h6" />
              </svg>
            </div>
            Client Overview & Management
          </a>
          <a href="trainer-host-virtualclass.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 10l4.553 2.276a1 1 0 010 1.448L15 16m0-6v6m-6-6h.01M6 10h.01" />
              </svg>
            </div>
            Virtual Classes
          </a>
          <a href="trainer-feedback.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 17h2M12 12v3m-1 0h2m-6 4h8a2 2 0 002-2v-6a2 2 0 00-2-2h-8a2 2 0 00-2 2v6a2 2 0 002 2z" />
              </svg>
            </div>
            Feedback
          </a>
        </nav>
      </div>

      <button id="logoutButton" class="btn-logout">
        <div class="nav-icon-container">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1" />
          </svg>
        </div>
        Logout
      </button>
    </aside>

    <div id="mobile-overlay" class="mobile-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <header class="header">
        <button id="menu-toggle" class="menu-toggle-btn">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
          </svg>
        </button>
        <h1 class="header-title">Trainer Dashboard</h1>
        <div class="header-actions">
          <span class="notification-bell">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round"
                stroke-width="2"
                d="M15 17h5l-1.405-1.405C18.66 14.88 19 13.97 19 13v-2a6 6 0 00-6-6V5a3 3 0 00-6 0v2a6 6 0 00-6 6v2c0 .97.34 1.88.405 2.595L4 17h5m-1-5v2m2-2h-2m-4 0h-2" />
            </svg>
            <span class="notification-badge">
              <span id="unreadNotificationsCount">0</span>
            </span>
          </span>
          <div class="profile-pic-placeholder"></div>
        </div>
      </header>

      <div class="grid-container grid-container-main">
        <!-- Trainer Profile Card -->
        <div class="card">
          <img id="trainerProfilePic"
            src="https://placehold.co/128x128/FF0000/FFFFFF?text=Trainer"
            alt="Trainer Profile" class="trainer-profile-pic"
            onerror="this.onerror=null;this.src='https://placehold.co/128x128/FF0000/FFFFFF?text=Trainer';" />
          <h3>Trainer Profile</h3>
          <p class="trainer-name" id="trainerName">Loading...</p>
          <p class="trainer-id" id="trainerId">ID: Loading...</p>
        </div>

        <!-- KPI Cards Grid -->
        <div class="kpi-grid">
          <!-- Total Diet Plans Created Card -->
          <div class="card kpi-card">
            <div class="kpi-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
            </div>
            <h4>Total Diet Plans Created</h4>
            <p id="totalDietPlans">0</p>
          </div>

          <!-- Total Workout Plans Created Card -->
          <div class="card kpi-card">
            <div class="kpi-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
            </div>
            <h4>Total Workout Plans Created</h4>
            <p id="totalWorkoutPlans">0</p>
          </div>

          <!-- Total Virtual Classes Scheduled Card -->
          <div class="card kpi-card">
            <div class="kpi-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 10l4.553 2.276a1 1 0 010 1.448L15 16m0-6v6m-6-6h.01M6 10h.01" />
              </svg>
            </div>
            <h4>Total Virtual Classes Scheduled</h4>
            <p id="totalVirtualClasses">0</p>
          </div>

          <!-- Total Clients Managed Card -->
          <div class="card kpi-card">
            <div class="kpi-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <h4>Total Clients Managed</h4>
            <p id="totalClientsManaged">0</p>
          </div>
        </div>
      </div>

      <!-- New container for Chart and Video side-by-side -->
      <div class="grid-container chart-video-grid">
        <!-- Average Feedback Rating Chart Card (Left) -->
        <div class="card">
          <div class="chart-video-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round"
                stroke-width="2"
                d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
            </svg>
            <h3>Average Feedback Rating</h3>
          </div>
          <div class="chart-container">
            <canvas id="feedbackRatingChart"></canvas>
            <p class="chart-rating-text" id="feedbackRatingText">Rating: N/A</p>
          </div>
        </div>

        <!-- Trainer Intro Video Card (Right) -->
        <div class="card">
          <div class="chart-video-header">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round"
                stroke-width="2"
                d="M15 10l4.553 2.276a1 1 0 010 1.448L15 16m0-6v6m-6-6h.01M6 10h.01" />
            </svg>
            <h3>Trainer Introduction Video</h3>
          </div>
          <div id="introVideoContainer" class="video-container">
            <p id="noVideoMessage" class="no-video-message">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor"
                style="width: 1.5rem; height: 1.5rem;">
                <path stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 10l4.553 2.276a1 1 0 010 1.448L15 16m0-6v6m-6-6h.01M6 10h.01" />
              </svg>
              No introduction video uploaded yet
            </p>
          </div>
          <button id="changeVideoUrlButton" class="btn-change-video">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            Change Video URL
          </button>
        </div>
      </div>

    </main>
    <script src="trainer-logout.js"></script>
    <script>
    // --- Mobile Navigation Toggle ---
    document.addEventListener('DOMContentLoaded', () => {
        const menuButton = document.getElementById('menu-toggle');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('mobile-overlay');

        function closeMenu() {
            sidebar.classList.remove('is-open');
            overlay.classList.remove('is-active');
        }

        if (menuButton && sidebar && overlay) {
            menuButton.addEventListener('click', () => {
                sidebar.classList.toggle('is-open');
                overlay.classList.toggle('is-active');
            });

            overlay.addEventListener('click', closeMenu);
        }

        // --- Original Dashboard Logic ---
        let trainerId = null;
        let trainerName = null;

        // Function to fetch session data
        async function fetchSessionData() {
            try {
                const response = await fetch('/api/user-session');
                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn('No active session, redirecting to login.');
                        window.location.href = '../login.html';
                        return null;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.userType === 'trainer') {
                    trainerId = data.userId;
                    trainerName = data.userName;
                    document.getElementById('trainerId').textContent = `ID: ${trainerId}`;
                    document.getElementById('trainerName').textContent = trainerName;
                    return {
                        trainerId,
                        trainerName
                    };
                } else {
                    console.warn('User is not a trainer, redirecting to login.');
                    window.location.href = '../login.html';
                    return null;
                }
            } catch (error) {
                console.error('Error fetching session data:', error);
                window.location.href = '../login.html';
                return null;
            }
        }

        // Function to fetch KPI data and trainer media
        async function fetchTrainerData(id) {
            try {
                const response = await fetch(`/api/trainer-dashboard-kpis?trainerId=${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching trainer data:', error);
                return null;
            }
        }

        // Function to render the feedback chart
        function renderFeedbackChart(rating) {
            const ctx = document.getElementById('feedbackRatingChart').getContext('2d');
            if (window.feedbackChartInstance) {
                window.feedbackChartInstance.destroy();
            }

            const defaultRating = 3;
            const displayRating = rating !== null ? parseFloat(rating).toFixed(1) : defaultRating.toFixed(1);

            document.getElementById('feedbackRatingText').textContent = `Rating: ${displayRating}/5`;

            window.feedbackChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Average Rating', 'Remaining'],
                    datasets: [{
                        data: [displayRating, 5 - displayRating],
                        backgroundColor: ['#EF4444', '#FEE2E2'],
                        borderColor: ['#EF4444', '#FEE2E2'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
        }


        // Function to update the intro video URL
        async function updateIntroVideoURL(url) {
            try {
                const response = await fetch('/api/trainer/update-intro-video-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoUrl: url
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Video Updated!',
                        text: result.message || 'Introduction video URL updated successfully.',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    renderIntroVideo(result.videoUrl);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Update Failed!',
                        text: result.message || 'Failed to update video URL. Please try again.',
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'An error occurred during video URL update. Please try again.',
                });
            }
        }

        // Function to dynamically render the intro video
        function renderIntroVideo(videoUrl) {
            const introVideoContainer = document.getElementById('introVideoContainer');
            const noVideoMessage = document.getElementById('noVideoMessage');
            introVideoContainer.innerHTML = ''; // Clear previous content

            if (videoUrl) {
                const youtubeMatch = videoUrl.match(/(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([a-zA-Z0-9_-]{11})/);

                if (youtubeMatch && youtubeMatch[1]) {
                    const embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=0&controls=1`;
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.setAttribute('frameborder', '0');
                    iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                    iframe.setAttribute('allowfullscreen', '');
                    introVideoContainer.appendChild(iframe);
                } else {
                    const video = document.createElement('video');
                    video.controls = true;
                    video.src = videoUrl;
                    introVideoContainer.appendChild(video);
                }
            } else {
                introVideoContainer.appendChild(noVideoMessage);
            }
        }


        // Main execution flow
        (async () => {
            const session = await fetchSessionData();
            if (session) {
                const trainerData = await fetchTrainerData(session.trainerId);
                if (trainerData) {
                    document.getElementById('totalDietPlans').textContent = trainerData.TotalDietPlansCreated || 0;
                    document.getElementById('totalWorkoutPlans').textContent = trainerData.TotalWorkoutPlansCreated || 0;
                    document.getElementById('totalVirtualClasses').textContent = trainerData.TotalVirtualClassesScheduled || 0;
                    document.getElementById('totalClientsManaged').textContent = trainerData.TotalClientsManaged || 0;
                    document.getElementById('unreadNotificationsCount').textContent = trainerData.UnreadNotificationsTrainer || 0;

                    renderFeedbackChart(trainerData.AverageFeedbackRating);

                    const trainerProfilePic = document.getElementById('trainerProfilePic');
                    if (trainerData.ProfilePic) {
                        trainerProfilePic.src = `data:image/jpeg;base64,${trainerData.ProfilePic}`;
                    }
                    
                    renderIntroVideo(trainerData.IntroVideoURL);

                } else {
                    renderFeedbackChart(null);
                    renderIntroVideo(null);
                }
            } else {
                renderFeedbackChart(null);
                renderIntroVideo(null);
            }

            document.getElementById('logoutButton').addEventListener('click', handleLogout);

            document.getElementById('changeVideoUrlButton').addEventListener('click', async () => {
                const {
                    value: youtubeUrl
                } = await Swal.fire({
                    title: 'Enter YouTube Video URL',
                    input: 'text',
                    inputLabel: 'YouTube URL',
                    inputPlaceholder: 'e.g., https://www.youtube.com/watch?v=...',
                    showCancelButton: true,
                    confirmButtonText: 'Update Video',
                    inputValidator: (value) => {
                        if (!value) return 'Please enter a URL!';
                        const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([a-zA-Z0-9_-]{11})/;
                        if (!youtubeRegex.test(value)) return 'Please enter a valid YouTube URL!';
                        return null;
                    }
                });

                if (youtubeUrl) {
                    await updateIntroVideoURL(youtubeUrl);
                }
            });
        })();
    });
  </script>
  </body>

</html>
