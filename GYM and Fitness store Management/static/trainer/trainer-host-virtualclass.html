<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Fitness Trainer - Virtual Class Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="trainer-logout.js"></script>
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/trainer-host-virtualclass.css">
    <style>
    </style>
  </head>

  <body>
    <aside class="sidebar">
      <div>
        <a href="trainer-dashboard.html" class="logo">
          <img
            src="https://cdn.pixabay.com/photo/2014/03/25/16/25/gym-297059_640.png"
            alt="Trainer Logo" />
          <h2>E-Fitness Trainer</h2>
        </a>

        <nav class="main-nav">
          <a href="trainer-reg-and-profile.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            Profile Management
          </a>
          <a href="trainer-Diet-Plan-Management.html"
            class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 17v-2a4 4 0 014-4h4" />
              </svg>
            </div>
            Diet Plan Management
          </a>
          <a href="trainer-Workout-Plan-Management.html"
            class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 17v-2a4 4 0 014-4h4" />
              </svg>
            </div>
            Workout Plan Management
          </a>
          <a href="trainer-client-management.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 8h10M7 12h8m-8 4h6" />
              </svg>
            </div>
            Client Overview & Management
          </a>
          <a href="trainer-host-virtualclass.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 10l4.553 2.276a1 1 0 010 1.448L15 16m0-6v6m-6-6h.01M6 10h.01" />
              </svg>
            </div>
            Virtual Classes
          </a>
          <a href="trainer-feedback.html" class="nav-link">
            <div class="nav-icon-container">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 17h2M12 12v3m-1 0h2m-6 4h8a2 2 0 002-2v-6a2 2 0 00-2-2h-8a2 2 0 00-2 2v6a2 2 0 002 2z" />
              </svg>
            </div>
            Feedback
          </a>
        </nav>
      </div>

      <button id="logoutButton" class="btn-logout">
        <div class="nav-icon-container">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1" />
          </svg>
        </div>
        Logout
      </button>
    </aside>

    <main class="main-content">

      <section id="virtual-classes" class="section-card">
        <h2 class="section-title">Host a Virtual Class</h2>
        <form id="virtualClassForm" class="form-grid">
          <input type="hidden" id="trainerId"
            value="<!--TrainerID here dynamically-->" />
          <div class="form-group">
            <label for="classTitle">Title</label>
            <input type="text" id="classTitle" required class="form-input"
              placeholder="Enter class title" />
          </div>
          <div class="form-group">
            <label for="classPlatform">Platform</label>
            <select id="classPlatform" required class="form-select">
              <option value disabled selected>Select a platform</option>
              <option value="Zoom">Zoom</option>
              <option value="GoogleMeet">GoogleMeet</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="startTime">Start Time</label>
            <input type="datetime-local" id="startTime" required
              class="form-input" />
          </div>
          <div class="form-group">
            <label for="duration">Duration (minutes)</label>
            <input type="number" id="duration" required min="1"
              class="form-input" />
          </div>
          <div class="form-group form-group-span-2">
            <label for="joinLink">Join Link</label>
            <input type="url" id="joinLink" required class="form-input"
              placeholder="https://..." />
          </div>
          <div class="form-group form-group-span-2">
            <label for="description">Description</label>
            <textarea id="description" rows="3" class="form-textarea"
              placeholder="Brief description..."></textarea>
          </div>
          <div class="form-group form-group-span-2 form-submit-container">
            <input type="hidden" id="classId" name="classId" value>
            <button type="submit" id="submitBtn" class="btn-submit">Create
              Class</button>
          </div>
        </form>

        <div id="classList" class="class-list-container">
          <h3 class="class-list-title">Your Virtual Classes</h3>
          <div id="classCards" class="class-cards-grid">
            <!-- Dynamic class cards go here -->
          </div>
        </div>
      </section>
      <script>
            document.getElementById('virtualClassForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const classId = document.getElementById('classId').value;
                const data = {
                    Title: document.getElementById('classTitle').value,
                    Description: document.getElementById('description').value,
                    StartTime: document.getElementById('startTime').value,
                    DurationMinutes: document.getElementById('duration').value,
                    Platform: document.getElementById('classPlatform').value,
                    JoinLink: document.getElementById('joinLink').value
                };
                const endpoint = classId ? `/trainer/virtual-classes/update/${classId}` : '/trainer/virtual-classes/create';
                const method = classId ? 'PUT' : 'POST';
                try {
                    const response = await fetch(endpoint, {
                        method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.success) {
                        Swal.fire('Success', result.message, 'success');
                        document.getElementById('virtualClassForm').reset();
                        document.getElementById('submitBtn').textContent = 'Create Class';
                        document.getElementById('classId').value = '';
                        fetchClasses();
                    } else {
                        Swal.fire('Error', result.message || 'Something went wrong.', 'error');
                    }
                } catch (err) {
                    console.error('❌ Server error:', err);
                    Swal.fire('Error', 'Failed to connect to server.', 'error');
                }
            });
            async function fetchClasses() {
                try {
                    const res = await fetch('/trainer/virtual-classes', {
                        credentials: 'include'
                    });
                    const contentType = res.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const html = await res.text();
                        console.error('Received HTML instead of JSON:', html);
                        return Swal.fire('Error', 'Invalid response format from server.', 'error');
                    }
                    const classes = await res.json();
                    const container = document.getElementById('classCards');
                    container.innerHTML = '';
                    classes.forEach(cls => {
                        const card = document.createElement('div');
                        card.className = 'class-card';
                        card.innerHTML = `
                            <h4>${cls.Title}</h4>
                            <p style="color: var(--gray-600);">${new Date(cls.StartTime).toLocaleString()}</p>
                            <p>Platform: <span style="font-weight: 500;">${cls.Platform}</span></p>
                            <p style="color: var(--gray-700);">${cls.Description || ''}</p>
                            <a href="${cls.JoinLink}" target="_blank">Join Link</a>
                            <button class="btn btn-edit" data-id="${cls.ClassID}">Edit</button>
                            <button class="btn btn-delete" data-id="${cls.ClassID}">Delete</button>
                        `;
                        container.appendChild(card);
                    });
                    container.querySelectorAll('.btn-delete').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const classId = btn.getAttribute('data-id');
                            const confirmed = await Swal.fire({
                                title: 'Are you sure?',
                                text: 'This will permanently delete the class.',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Yes, delete it!',
                                cancelButtonText: 'Cancel',
                            });
                            if (confirmed.isConfirmed) {
                                try {
                                    const response = await fetch(`/trainer/virtual-classes/delete/${classId}`, {
                                        method: 'DELETE',
                                        credentials: 'include'
                                    });
                                    const result = await response.json();
                                    if (result.success) {
                                        Swal.fire('Deleted!', result.message, 'success');
                                        fetchClasses();
                                        if (document.getElementById('classId').value === classId) {
                                            document.getElementById('virtualClassForm').reset();
                                            document.getElementById('submitBtn').textContent = 'Create Class';
                                            document.getElementById('classId').value = '';
                                        }
                                    } else {
                                        Swal.fire('Error', result.message || 'Failed to delete class.', 'error');
                                    }
                                } catch (err) {
                                    console.error('❌ Delete error:', err);
                                    Swal.fire('Error', 'Server error during delete.', 'error');
                                }
                            }
                        });
                    });
                    container.querySelectorAll('.btn-edit').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const classId = btn.getAttribute('data-id');
                            const cls = classes.find(c => c.ClassID == classId);
                            document.getElementById('classTitle').value = cls.Title;
                            document.getElementById('description').value = cls.Description;
                            document.getElementById('startTime').value = cls.StartTime.replace('Z', '');
                            document.getElementById('duration').value = cls.DurationMinutes;
                            document.getElementById('classPlatform').value = cls.Platform;
                            document.getElementById('joinLink').value = cls.JoinLink;
                            document.getElementById('classId').value = cls.ClassID;
                            document.getElementById('submitBtn').textContent = 'Update Class';
                        });
                    });
                } catch (err) {
                    console.error('❌ Failed to load classes:', err);
                    Swal.fire('Error', 'Could not load virtual classes.', 'error');
                }
            }
            window.addEventListener('load', fetchClasses);
        </script>
    </main>
  </body>

</html>
