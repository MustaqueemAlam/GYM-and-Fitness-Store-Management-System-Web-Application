<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Client Dashboard - E-Fitness</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body class="flex h-screen bg-gradient-to-r from-red-50 to-red-100">
        <!-- Sidebar -->
        <aside
            class="w-64 bg-white border-r border-gray-200 p-5 flex flex-col justify-between">
            <div>
                <!-- Logo + Title -->
                <a href="client-dashboard.html"
                    class="flex items-center gap-3 mb-8 hover:opacity-90 transition">
                    <img
                        src="https://cdn.pixabay.com/photo/2014/03/25/16/25/gym-297059_640.png"
                        alt="Gym Logo"
                        class="w-10 h-10 rounded-full object-cover shadow-md" />
                    <h2 class="text-2xl font-bold text-red-700">E-Fitness
                        Client</h2>
                </a>

                <!-- Navigation -->
                <nav class="flex flex-col space-y-3 text-gray-700 font-medium">
                    <a href="client-reg-and-prof.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: User -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                stroke-width="2"
                                d="M5.121 17.804A9 9 0 1112 21a9 9 0 01-6.879-3.196z" />
                        </svg>
                        Registration & Profile
                    </a>
                    <a href="client-regular-prog-tracker.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Credit Card -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <rect width="20" height="12" x="2" y="6" rx="2"
                                ry="2"
                                stroke-width="2" stroke-linejoin="round"
                                stroke-linecap="round"></rect>
                            <line x1="2" y1="10" x2="22" y2="10"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                        </svg>
                        Progress Tracker
                    </a>
                    <a href="client-diet-management.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Calendar -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <rect x="3" y="4" width="18" height="18" rx="2"
                                ry="2"
                                stroke-width="2" stroke-linejoin="round"
                                stroke-linecap="round"></rect>
                            <line x1="16" y1="2" x2="16" y2="6" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                            <line x1="8" y1="2" x2="8" y2="6" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                            <line x1="3" y1="10" x2="21" y2="10"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                        </svg>
                        Diet Management
                    </a>
                    <a href="client-daily-progress.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Chart Line -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <polyline points="3 17 9 11 13 15 21 7"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></polyline>
                            <circle cx="3" cy="17" r="2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                            <circle cx="9" cy="11" r="2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                            <circle cx="13" cy="15" r="2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                            <circle cx="21" cy="7" r="2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                        </svg>
                        Daily Progress and Attendance
                    </a>
                    <a href="client-fitness-store.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Shopping Cart -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></path>
                            <circle cx="7" cy="21" r="2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                            <circle cx="17" cy="21" r="2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                        </svg>
                        Fitness Store
                    </a>
                    <a href="client-subscription-management.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Document Text -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path d="M9 12h6M9 16h6M13 8h-2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></path>
                            <path d="M4 4h16v16H4z" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></path>
                        </svg>
                        Subscription Management
                    </a>
                    <a href="client-fitness-goals.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Target -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <circle cx="12" cy="12" r="10" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                            <circle cx="12" cy="12" r="6" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                            <circle cx="12" cy="12" r="2" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></circle>
                        </svg>
                        Fitness Goals
                    </a>
                    <a href="client-workout-sessions.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Heart -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path d="M4 12l1.41 1.41L12 7.83l6.59 6.58L20 12"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></path>
                        </svg>
                        Workout and sessions
                    </a>
                    <a href="client-virtual-classes.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Newspaper -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <rect x="3" y="4" width="18" height="16" rx="2"
                                ry="2"
                                stroke-width="2" stroke-linejoin="round"
                                stroke-linecap="round"></rect>
                            <line x1="7" y1="8" x2="17" y2="8" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                            <line x1="7" y1="12" x2="17" y2="12"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                            <line x1="7" y1="16" x2="17" y2="16"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                        </svg>
                        Virtual classes
                    </a>
                    <a href="client-Feedback.html"
                        class="flex items-center gap-3 hover:text-red-600 transition-colors">
                        <!-- Icon: Newspaper -->
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-red-500"
                            fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <rect x="3" y="4" width="18" height="16" rx="2"
                                ry="2"
                                stroke-width="2" stroke-linejoin="round"
                                stroke-linecap="round"></rect>
                            <line x1="7" y1="8" x2="17" y2="8" stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                            <line x1="7" y1="12" x2="17" y2="12"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                            <line x1="7" y1="16" x2="17" y2="16"
                                stroke-width="2"
                                stroke-linejoin="round"
                                stroke-linecap="round"></line>
                        </svg>
                        Feedback
                    </a>
                </nav>
            </div>

            <div class="text-center text-xs text-gray-400 mt-6">
                &copy; 2025 E-Fitness. All rights reserved.
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-8">
            <div class="container mx-auto bg-white p-8 rounded-lg shadow-xl">
                <h1
                    class="text-4xl font-extrabold mb-8 text-center text-red-800">Your
                    Progress Tracker</h1>

                <section class="mb-12 border-b pb-8 border-gray-200">
                    <h2
                        class="text-3xl font-bold mb-6 text-gray-800 border-l-4 border-blue-500 pl-3">Add
                        Progress Snapshot</h2>
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label for="snapshotDate"
                                class="block text-sm font-semibold text-gray-700 mb-1">Date:</label>
                            <input type="date" id="snapshotDate"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="weightKg"
                                class="block text-sm font-semibold text-gray-700 mb-1">Weight
                                (kg):</label>
                            <input type="number" id="weightKg" step="0.1"
                                placeholder="e.g., 75.5"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="bodyFatPercent"
                                class="block text-sm font-semibold text-gray-700 mb-1">Body
                                Fat (%):</label>
                            <input type="number" id="bodyFatPercent" step="0.1"
                                placeholder="e.g., 18.2"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="bmi"
                                class="block text-sm font-semibold text-gray-700 mb-1">BMI:</label>
                            <input type="text" id="bmi"
                                placeholder="Calculated automatically"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 bg-gray-100 text-gray-600 cursor-not-allowed"
                                readonly>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="snapshotNotes"
                                class="block text-sm font-semibold text-gray-700 mb-1">Notes:</label>
                            <textarea id="snapshotNotes" rows="3"
                                placeholder="Any additional notes on your progress..."
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="progressImage"
                                class="block text-sm font-semibold text-gray-700 mb-1">Upload
                                Image (Optional):</label>
                            <input type="file" id="progressImage"
                                accept="image/*"
                                class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer">
                        </div>
                    </div>
                    <button id="addSnapshotBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105">
                        Add Progress Snapshot
                    </button>

                    <h3
                        class="text-2xl font-bold mt-10 mb-5 text-gray-800 border-l-4 border-blue-500 pl-3">Your
                        Progress History</h3>
                    <div
                        class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Weight
                                        (kg)</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Body
                                        Fat (%)</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">BMI</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Notes</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Image</th>
                                </tr>
                            </thead>
                            <tbody id="progressSnapshotTableBody"
                                class="bg-white divide-y divide-gray-200 text-gray-700 text-sm">
                            </tbody>
                        </table>
                    </div>
                </section>

                <section>
                    <h2
                        class="text-3xl font-bold mb-6 text-gray-800 border-l-4 border-green-500 pl-3">Add
                        Workout Log</h2>
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label for="workoutDate"
                                class="block text-sm font-semibold text-gray-700 mb-1">Date:</label>
                            <input type="date" id="workoutDate"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="exercise"
                                class="block text-sm font-semibold text-gray-700 mb-1">Exercise:</label>
                            <select id="exercise"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                                <option value>Select Exercise</option>
                            </select>
                        </div>
                        <div>
                            <label for="sets"
                                class="block text-sm font-semibold text-gray-700 mb-1">Sets:</label>
                            <input type="number" id="sets" min="1"
                                placeholder="e.g., 3"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="reps"
                                class="block text-sm font-semibold text-gray-700 mb-1">Reps:</label>
                            <input type="number" id="reps" min="1"
                                placeholder="e.g., 10"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="weightUsed"
                                class="block text-sm font-semibold text-gray-700 mb-1">Weight
                                Used (kg):</label>
                            <input type="number" id="weightUsed" step="0.1"
                                placeholder="e.g., 50.0"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="heartRate"
                                class="block text-sm font-semibold text-gray-700 mb-1">Heart
                                Rate (BPM, Optional):</label>
                            <input type="number" id="heartRate"
                                placeholder="e.g., 140"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="caloriesBurned"
                                class="block text-sm font-semibold text-gray-700 mb-1">Calories
                                Burned (Optional):</label>
                            <input type="number" id="caloriesBurned"
                                placeholder="e.g., 300"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div>
                            <label for="fatigueLevel"
                                class="block text-sm font-semibold text-gray-700 mb-1">Fatigue
                                Level:</label>
                            <select id="fatigueLevel"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                                <option value="Low">Low</option>
                                <option value="Moderate"
                                    selected>Moderate</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="clientFeedback"
                                class="block text-sm font-semibold text-gray-700 mb-1">Your
                                Feedback:</label>
                            <textarea id="clientFeedback" rows="3"
                                placeholder="How did you feel during this workout?"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-green-500 focus:border-green-500"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label for="workoutAttachment"
                                class="block text-sm font-semibold text-gray-700 mb-1">Upload
                                Attachment (Optional):</label>
                            <input type="file" id="workoutAttachment"
                                class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200 cursor-pointer">
                        </div>
                    </div>
                    <button id="addWorkoutBtn"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105">
                        Add Workout Log
                    </button>

                    <h3
                        class="text-2xl font-bold mt-10 mb-5 text-gray-800 border-l-4 border-green-500 pl-3">Your
                        Workout History</h3>
                    <div
                        class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-green-50">
                                <tr>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Exercise</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Sets</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Reps</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Weight
                                        (kg)</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Heart
                                        Rate</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Calories</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fatigue</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Feedback</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Trainer
                                        Notes</th>
                                    <th scope="col"
                                        class="py-3 px-6 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Attachment</th>
                                </tr>
                            </thead>
                            <tbody id="workoutLogTableBody"
                                class="bg-white divide-y divide-gray-200 text-gray-700 text-sm">
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>

        <script>
        let currentClientId = null; // This will be set by fetchSession and then used.

        document.addEventListener('DOMContentLoaded', async () => {
            // First, establish the session and get currentClientId
            await fetchSession(); 
            
            // If currentClientId is successfully set, then fetch other data
            if (currentClientId) {
                await fetchExercises(); // This doesn't depend on client ID
                await fetchProgressSnapshots(); // This now relies on the currentClientId set by fetchSession
                await fetchWorkoutLogs(); // This also relies on currentClientId
            }

            // Set current date for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('snapshotDate').value = today;
            document.getElementById('workoutDate').value = today;

            // Event Listeners
            // These event listeners will now trigger functions that use the `currentClientId`
            // from the enclosing scope.
            document.getElementById('addSnapshotBtn').addEventListener('click', addProgressSnapshot);
            document.getElementById('addWorkoutBtn').addEventListener('click', addWorkoutLog);

            document.getElementById('weightKg').addEventListener('input', calculateBMI);
        });

        async function fetchSession() {
            try {
                // Fetch the session using a relative path, assuming your frontend serves or proxies this.
                const response = await fetch('/api/user-session', { credentials: 'include' }); 
                
                if (!response.ok) {
                    throw new Error('Not authenticated');
                }
                const data = await response.json();
                if (data.userType === 'client') {
                    currentClientId = data.userId; // Set the module-level currentClientId
                    console.log('Client ID:', currentClientId);
                } else {
                    Swal.fire('Error', 'Only clients can access this page.', 'error').then(() => {
                        window.location.href = 'login.html'; // Redirect to login
                    });
                }
            } catch (error) {
                console.error('Session fetch error:', error);
                Swal.fire('Error', 'Please log in as a client to access this page.', 'error').then(() => {
                    window.location.href = 'login.html'; // Redirect to login
                });
            }
        }

        function calculateBMI() {
            const weightKg = parseFloat(document.getElementById('weightKg').value);
            const heightMeters = 1.75; // Example height: 175 cm = 1.75 meters

            if (weightKg > 0 && heightMeters > 0) {
                const bmi = weightKg / (heightMeters * heightMeters);
                document.getElementById('bmi').value = bmi.toFixed(2);
            } else {
                document.getElementById('bmi').value = '';
            }
        }

        async function fetchExercises() {
            try {
                // Use relative path for API calls
                const response = await fetch('/api/exercises', { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const exercises = await response.json();
                const exerciseSelect = document.getElementById('exercise');
                exerciseSelect.innerHTML = '<option value="">Select Exercise</option>'; // Clear existing options
                exercises.forEach(exercise => {
                    const option = document.createElement('option');
                    option.value = exercise.ExerciseID;
                    option.textContent = exercise.ExerciseName;
                    exerciseSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching exercises:', error);
                Swal.fire('Error', 'Failed to load exercises.', 'error');
            }
        }

        async function addProgressSnapshot() {
            if (!currentClientId) {
                Swal.fire('Error', 'Client ID not available. Please refresh or log in.', 'error');
                return;
            }

            const dateTaken = document.getElementById('snapshotDate').value;
            const weightKg = parseFloat(document.getElementById('weightKg').value);
            const bodyFatPercent = parseFloat(document.getElementById('bodyFatPercent').value);
            const bmi = parseFloat(document.getElementById('bmi').value);
            const notes = document.getElementById('snapshotNotes').value;
            const progressImageFile = document.getElementById('progressImage').files[0];

            if (!dateTaken || isNaN(weightKg) || isNaN(bodyFatPercent) || isNaN(bmi)) {
                Swal.fire('Validation Error', 'Please fill in all required snapshot fields with valid numbers.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('dateTaken', dateTaken);
            formData.append('weightKg', weightKg);
            formData.append('bodyFatPercent', bodyFatPercent);
            formData.append('bmi', bmi);
            formData.append('notes', notes);
            if (progressImageFile) {
                formData.append('progressImage', progressImageFile);
            }

            try {
                // Use relative path for API calls, using currentClientId from the script's scope
                const response = await fetch(`/api/client/${currentClientId}/progress-snapshots`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();
                if (response.ok) {
                    Swal.fire('Success', data.message, 'success');
                    // Clear form fields
                    document.getElementById('snapshotDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('weightKg').value = '';
                    document.getElementById('bodyFatPercent').value = '';
                    document.getElementById('bmi').value = '';
                    document.getElementById('snapshotNotes').value = '';
                    document.getElementById('progressImage').value = '';
                    await fetchProgressSnapshots(); // Refresh the list
                } else {
                    Swal.fire('Error', data.message || 'Failed to add progress snapshot.', 'error');
                }
            } catch (error) {
                console.error('Error adding progress snapshot:', error);
                Swal.fire('Error', 'Failed to connect to the server. Please try again later.', 'error');
            }
        }

        async function fetchProgressSnapshots() {
            if (!currentClientId) {
                Swal.fire('Error', 'Client ID not available. Cannot fetch snapshots.', 'error');
                return;
            }
            try {
                // Use relative path for API calls
                const response = await fetch(`/api/client/${currentClientId}/progress-snapshots`, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const snapshots = await response.json();
                const tableBody = document.getElementById('progressSnapshotTableBody');
                tableBody.innerHTML = '';

                snapshots.forEach(snapshot => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = new Date(snapshot.DateTaken).toLocaleDateString();
                    row.insertCell().textContent = snapshot.WeightKg;
                    row.insertCell().textContent = snapshot.BodyFatPercent;
                    row.insertCell().textContent = snapshot.BMI;
                    row.insertCell().textContent = snapshot.Notes;

                    const imageCell = row.insertCell();
                    // Assumed that if SnapshotID exists, an image might exist, even if not directly returned in the list.
                    if (snapshot.SnapshotID) { 
                        const viewImageBtn = document.createElement('button');
                        viewImageBtn.textContent = 'View Image';
                        viewImageBtn.className = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs';
                        viewImageBtn.onclick = () => viewProgressImage(snapshot.SnapshotID); // Pass SnapshotID
                        imageCell.appendChild(viewImageBtn);
                    } else {
                        imageCell.textContent = 'N/A';
                    }
                });
            } catch (error) {
                console.error('Error fetching progress snapshots:', error);
                Swal.fire('Error', 'Failed to load progress snapshots.', 'error');
            }
        }

        async function viewProgressImage(snapshotId) {
            if (!currentClientId) {
                Swal.fire('Error', 'Client ID not available. Cannot view image.', 'error');
                return;
            }
            try {
                // Use relative path for API calls
                const response = await fetch(`/api/client/${currentClientId}/progress-snapshots/${snapshotId}/image`, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const imageBlob = await response.blob();
                const imageUrl = URL.createObjectURL(imageBlob);

                Swal.fire({
                    title: 'Progress Image',
                    imageUrl: imageUrl,
                    imageAlt: 'Client Progress Image',
                    imageWidth: 400,
                    imageHeight: 300,
                    confirmButtonText: 'Close',
                    didClose: () => URL.revokeObjectURL(imageUrl)
                });

            } catch (error) {
                console.error('Error viewing progress image:', error);
                Swal.fire('Error', 'Failed to load image. It might be corrupted or missing.', 'error');
            }
        }

        async function addWorkoutLog() {
            if (!currentClientId) {
                Swal.fire('Error', 'Client ID not available. Please refresh or log in.', 'error');
                return;
            }

            const datePerformed = document.getElementById('workoutDate').value;
            const exerciseId = document.getElementById('exercise').value;
            const setsDone = parseInt(document.getElementById('sets').value);
            const repsDone = parseInt(document.getElementById('reps').value);
            const weightUsedKg = parseFloat(document.getElementById('weightUsed').value);
            const heartRate = parseInt(document.getElementById('heartRate').value) || null;
            const caloriesBurned = parseInt(document.getElementById('caloriesBurned').value) || null;
            const fatigueLevel = document.getElementById('fatigueLevel').value;
            const clientFeedback = document.getElementById('clientFeedback').value;
            const workoutAttachmentFile = document.getElementById('workoutAttachment').files[0];

            if (!datePerformed || !exerciseId || isNaN(setsDone) || isNaN(repsDone) || isNaN(weightUsedKg)) {
                Swal.fire('Validation Error', 'Please fill in all required workout log fields.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('datePerformed', datePerformed);
            formData.append('exerciseId', exerciseId);
            formData.append('setsDone', setsDone);
            formData.append('repsDone', repsDone);
            formData.append('weightUsedKg', weightUsedKg);
            if (heartRate !== null) formData.append('heartRate', heartRate);
            if (caloriesBurned !== null) formData.append('caloriesBurned', caloriesBurned);
            formData.append('fatigueLevel', fatigueLevel);
            formData.append('clientFeedback', clientFeedback);
            if (workoutAttachmentFile) {
                formData.append('attachment', workoutAttachmentFile);
            }

            try {
                // Use relative path for API calls
                const response = await fetch(`/api/client/${currentClientId}/workouts`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();
                if (response.ok) {
                    Swal.fire('Success', data.message, 'success');
                    // Clear form fields
                    document.getElementById('workoutDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('exercise').value = '';
                    document.getElementById('sets').value = '';
                    document.getElementById('reps').value = '';
                    document.getElementById('weightUsed').value = '';
                    document.getElementById('heartRate').value = '';
                    document.getElementById('caloriesBurned').value = '';
                    document.getElementById('fatigueLevel').value = 'Moderate';
                    document.getElementById('clientFeedback').value = '';
                    document.getElementById('workoutAttachment').value = '';
                    await fetchWorkoutLogs(); // Refresh the list
                } else {
                    Swal.fire('Error', data.message || 'Failed to add workout log.', 'error');
                }
            } catch (error) {
                console.error('Error adding workout log:', error);
                Swal.fire('Error', 'Failed to connect to the server. Please try again later.', 'error');
            }
        }

        async function fetchWorkoutLogs() {
            if (!currentClientId) {
                Swal.fire('Error', 'Client ID not available. Cannot fetch workout logs.', 'error');
                return;
            }
            try {
                // Use relative path for API calls
                const response = await fetch(`/api/client/${currentClientId}/workouts`, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const workoutLogs = await response.json();
                const tableBody = document.getElementById('workoutLogTableBody');
                tableBody.innerHTML = '';

                workoutLogs.forEach(log => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = new Date(log.DatePerformed).toLocaleDateString();
                    row.insertCell().textContent = log.ExerciseName;
                    row.insertCell().textContent = log.SetsDone;
                    row.insertCell().textContent = log.RepsDone;
                    row.insertCell().textContent = log.WeightUsedKg;
                    row.insertCell().textContent = log.HeartRate || 'N/A';
                    row.insertCell().textContent = log.CaloriesBurned || 'N/A';
                    row.insertCell().textContent = log.FatigueLevel;
                    row.insertCell().textContent = log.ClientFeedback || 'N/A';
                    row.insertCell().textContent = log.TrainerNotes || 'N/A';

                    const attachmentCell = row.insertCell();
                    if (log.WorkoutLogID) { // Assuming WorkoutLogID implies an attachment *could* be present.
                        const viewAttachmentBtn = document.createElement('button');
                        viewAttachmentBtn.textContent = 'View/Download';
                        viewAttachmentBtn.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-xs';
                        viewAttachmentBtn.onclick = () => viewWorkoutAttachment(log.WorkoutLogID); // Pass WorkoutLogID
                        attachmentCell.appendChild(viewAttachmentBtn);
                    } else {
                        attachmentCell.textContent = 'N/A';
                    }
                });
            } catch (error) {
                console.error('Error fetching workout logs:', error);
                Swal.fire('Error', 'Failed to load workout logs.', 'error');
            }
        }

        async function viewWorkoutAttachment(workoutLogId) {
            if (!currentClientId) {
                Swal.fire('Error', 'Client ID not available. Cannot view attachment.', 'error');
                return;
            }
            try {
                // Use relative path for API calls
                const response = await fetch(`/api/client/${currentClientId}/workouts/${workoutLogId}/attachment`, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const attachmentBlob = await response.blob();
                const attachmentUrl = URL.createObjectURL(attachmentBlob);

                Swal.fire({
                    title: 'Workout Attachment',
                    html: `
                        <p>A file is available for download.</p>
                        <a href="${attachmentUrl}" download class="text-blue-600 underline">Click to Download Attachment</a>
                    `,
                    icon: 'info',
                    confirmButtonText: 'Close',
                    didClose: () => URL.revokeObjectURL(attachmentUrl)
                });

            } catch (error) {
                console.error('Error viewing workout attachment:', error);
                Swal.fire('Error', 'Failed to load attachment. It might be corrupted or missing.', 'error');
            }
        }
    </script>
    </body>
</html>